## WebRTC란?
- Web Real-Time Communication의 약자
- 웹, 앱(안드로이드, IOS)에서 별 다른 소프트웨어 없이 카메라, 마이크 등을 사용해서 실시간 커뮤니케이션을 제공해 주는 기술
- 화상회의를 구현할 수 있는 오픈소스
- UDP 기반의 P2P

즉, 웹브라우저 간에 플러그인의 도움 없이 서로 통신할 수 있도록 설계되었으면 JavaScript API를 통해 실행할 수 있습니다.


## WebRTC의 동작과정

P2P 기반의 Mesh 방식, MCU 방식, SFU방식이 존재합니다.

크게 나누어 보았을 때 다음과 같이 구분됩니다.

1. 각각의 클라이언트가 모두 자신의 미디어 스트림을 나머지 피어들에게 직접 전달. (P2P 기반의 Mesh)

2. 여러 피어들이 자신들의 미디어 스트림을 중앙 서버에 보내고 서버가 이를 처리하여 피어들에게 전달. (MCU/ SFU방식)

## P2P 기반의 Connection으로 동작하는 WebRTC

중간에 서버가 없이 사용자와 사용자가 연결을 수립하고 이를 통해 문자 , 음성 , 영상을 주고받습니다.

인터넷에서는 데이터를 주고받기 위해서 HTTP 프로토콜을 사용합니다.


브라우저가 서버에게 HTTP 요청을 보내면 서버는 브라우저에게 HTTP 응답 메시지를 보내면서 통신을 합니다.

하지만 HTTP는 서버가 브라우저 요청에 응답하고 나면 통신이 끝나게 됩니다.

즉, 한번 응답이 끝나면 서버는 클라이언트와 통신이 끊기고 브라우저가 요청을 했을 때만 응답합니다.

만약 HTTP를 통해서 채팅과 같은 양방향 통신을 구현하게 된다면 새로운 메시지가 왔는지 확인하기 위해 n초마다 무한하게 클라이언트가 서버에게 "나에게 줄 채팅 정보 있어?"라고 묻는 방식으로 구현할 수 있습니다.

이를 polling 기법이라고 합니다.

#### Long Polling 기법

또 이를 조금 보완하기 위한 Long polling 기법 또한 존재하는데 N초마다 무한히 물어보는 것이 아니라 클라이언트가 HTTP 요청을 보내서 특정 이벤트까지 계속 기다리다가 서버가 응답해주면 다시 클라이언트가 HTTP 요청을 특정 이벤트까지 기다리는 방식입니다.


### 웹소켓 등장

이런 HTTP의 단방향성을 극복하고자 웹소켓이 등장하게 됩니다.

웹 소켓은 HTTP처럼 응답, 요청 방식이 아닌 커넥션을 가지며 이는 Open -Close 된 여부로 판단합니다.

 브라우저가 웹소켓을 이용해 서버와 연결하면 통신을 원하는 순간까지 계속 열려있게 됩니다.

HTTP는 벽이랑 탁구를 치는 셈이고 웹소켓은 전화통화를 하는 것과 유사합니다.

이런 양방향 통신을 통해 서버와 브라우저는 문자, 음성 , 영상을 주고받을 수 있습니다.

채팅의 참여자들의 서버에 참여하고 서버는 모든 참여자 들고 연결하고 정보를 제공해야 하기 때문에 서버의 메모리 파워가 중요합니다.


### WebRTC 등장
여기서 서버의 부하를 극복하기 위해 WebRTC가 등장하게 됩니다.

채팅의 참여자들이 서버에 접속하는 것이 아니라 P2P로 서로서로 브라우저끼리 연결됩니다.

문자, 음성, 영상들이 서버를 통해 전송되지 않으며 중간 매개체가 없기 때문에 더 빠릅니다.

하지만 채팅방에 1000명의 사람이 존재한다면 컴퓨터는 999개의 데이터들을 모두 수신해야 합니다.

이로 인해 확장성에는 제약이 발생합니다.


### 그러면 서버는 필요하지 않을까요?
이론상으로 P2P 연결을 통해서 통신하기 때문에 서버는 필요 없어 보입니다.

 하지만 상대방과 통신하기 위해서는 상대방이 누구인지를 먼저 파악해야 하는데 이때 사용자를 묶어주는 역할을 하는 Signaling Server가 필요합니다.

### Signaling Server

서로 다른 네트워크에 있는 2개의 디바이스들이 통신하기 위해서는, 각 디바이스들의 IP를 알아야 하며 통신을 위한 미디어 포맷 협의가 필요합니다.

 

이러한 동작 과정을 시그널링이라 부릅니다.

 

#### 시그널링 서버를 통한 동작과정

1. 통신을 원하는 사용자는 상대 사용자에게 Signaling Server를 통해 자신의 정보들을 제공합니다.

2. 상대 사용자는 그 정보들에 대해 자신의 정보를 담아 답장합니다.


### 시그널링 서버의 한계

클라이언트가 방화벽이나 NAT뒤에 있는 경우가 대부분이기 때문에 Public IP 주소를 알아내기 어렵습니다.

이러한 문제를 해결하기 위해서는 STUN/TURN 서버를 이용하여 해결해야 합니다.

 

#### NAT이란?

IP주소에는 공인 IP와 사설 IP가 존재합니다.

공인 IP는 외부에 공개되어 있는 IP이며 사설 IP는 외부에 공개되어 있지 않은 주소입니다.

### ICE, STUN , TURN
STUN과 TURN서버

시그널링을 위해서 사설 IP를 공인 IP로 변환하기 위해서는 STUN서버 또는 TURN서버를 사용해야 합니다.

 

STUN(Session Traversal Utilites for NAT)

공용 네트워크 망에서 동작하며 NAT 뒤에 있는 공인 IP주소를 찾아서 반환합니다.

 

TURN(Traversal Using Replays around NAT)

NAT타입 또는 방화벽의 제한으로 P2P 연결이 실패했을 때 대안으로 사용합니다.

 

 

ICE(Interactive Connectivity Establishment)

두 단말이 서로 통신할 수 있는 최적의 경로를 찾을 수 있도록 도와주는 프레임워크입니다.

모든 가능성을 병렬로 시도하여 가장 효율적인 경로를 선택합니다.

 

동작 과정

1. ICE는 UDP를 통해 기기들을 서로 직접 연결 시도합니다.

2. 기기가 NAT 뒤에 있어 연결이 되지 않는다면 STUN 서버가 이를 해결해줍니다.

3. 이 또한 실패하면 모든 기기는 TURN 서버로 패킷을 보내고, 서버가 이를 가운데서 전달합니다.









 

